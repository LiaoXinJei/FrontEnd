<html lang="en">

<head>
    <title>日曆</title>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
        crossorigin="anonymous">
    <script defer src="https://use.fontawesome.com/releases/v5.0.9/js/all.js" integrity="sha384-8iPTk2s/jMVj81dnzb/iFR2sdA7u06vHJyyLlAd4snFpCl/SnyUjRrbdJsw1pGIl"
        crossorigin="anonymous"></script>
    <link rel="stylesheet" href="style.css">

    <script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>

    <style>
        body {
            font-family: '微軟正黑體';
        }

        th {
            color: white;
            background-color: rgb(239, 79, 105);
            height: 80px;
        }

        td {
            height: 110px;
        }

        table {
            word-wrap: break-word;
            table-layout: fixed;
        }

        .nowdate {
            color: white;
            background-color: rgb(239, 79, 105);
        }

        .text-gray {
            color: rgb(192, 192, 192);
        }

        .mapstyle {
            width: 470px;
            height: 470px;
        }
    </style>
</head>

<body>
    <div class="row">
        <div class="col-2"></div>
        <div class="btn-group col-8" role="group" aria-label="Basic example">
            <button id="gotoprev" type="button" class="btn" style="background-color:white;">
                <i class="fas fa-caret-left"></i>
            </button>
            <button type="button" class="btn btn-block" style=" background-color:white; ">
                <h1 id="calendar-month">March</h1>
                <h2 id="calendar-year">2018</h2>
            </button>
            <button id="gotonext" type="button" class="btn" style="background-color:white;">
                <i class="fas fa-caret-right"></i>
            </button>
        </div>
    </div>

    <table class="table table-bordered">
        <thead>
            <tr>
                <th>
                    <p class="text-center">日</p>
                </th>
                <th>
                    <p class="text-center">一</p>
                </th>
                <th>
                    <p class="text-center">二</p>
                </th>
                <th>
                    <p class="text-center">三</p>
                </th>
                <th>
                    <p class="text-center">四</p>
                </th>
                <th>
                    <p class="text-center">五</p>
                </th>
                <th>
                    <p class="text-center">六</p>
                </th>
            </tr>
        </thead>
        <tbody id="tbody">
        </tbody>
    </table>

    <!-- Modal -->
    <div class="modal fade bd-example-modal-lg" id="modelId" tabindex="-1" role="dialog" aria-labelledby="modelTitleId" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="modelTitleId">新增</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="form-group row">
                            <label for="inputEmail3" class="col-sm-2 col-form-label">時間：</label>
                            <div class="col-sm-10">
                                <input id="hour" type="email" class="form-control" placeholder="時">
                            </div>
                        </div>
                        <div class="form-group row">
                            <label for="inputPassword3" class="col-sm-2 col-form-label"></label>
                            <div class="col-sm-10">
                                <input id="minute" type="email" class="form-control" placeholder="分">
                            </div>
                        </div>
                        <fieldset class="form-group">
                            <div class="row">
                                <legend class="col-form-label col-sm-2 pt-0"></legend>
                                <div class="col-sm-10">
                                    <div class="form-check form-check-inline">
                                        <input id="morning" class="form-check-input" type="radio" name="gridRadios" value="option1" checked>
                                        <label class="form-check-label" for="gridRadios1">
                                            上午
                                        </label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input id="afternoon" class="form-check-input" type="radio" name="gridRadios" value="option2">
                                        <label class="form-check-label" for="gridRadios2">
                                            下午
                                        </label>
                                    </div>

                                </div>
                            </div>
                        </fieldset>
                        <div class="form-group row">
                            <div class="col-sm-2">待辦事項：</div>
                            <div class="col-sm-10">
                                <input id="affairs" type="email" class="form-control" placeholder="">
                            </div>
                        </div>
                        <div class="form-group row">
                            <div class="col-sm-2">地點：</div>
                            <div class="col-sm-10">
                                <div class="input-group">
                                    <input id="iptGoogleMap" type="text" class="form-control" placeholder="請輸入地址" aria-label="Recipient's username" aria-describedby="basic-addon2">
                                    <div class="input-group-append">
                                        <button id="btnGoogleMap" class="btn btn-primary" type="button" data-toggle="modal" data-target="#modalMap">Google地圖</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group row">
                            <div class="col-sm-2">選擇顏色：</div>
                            <div class="col-sm-10">
                                <input id="color" type="color" name="favcolor" value="#ff0000">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">關閉</button>
                    <button id="save" type="button" class="btn btn-primary" data-dismiss="modal">確定</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ModalMap -->
    <div class="modal fade" id="modalMap" tabindex="-1" role="document" aria-labelledby="modelTitleId" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="map" class="mapstyle"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">關閉</button>
                    <button id="saveMap" type="button" class="btn btn-primary" data-dismiss="modal">確定</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ModalResult -->
    <div class="modal fade bd-example-modal-lg" id="modalResult" tabindex="-1" role="dialog" aria-labelledby="modelTitleId" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="modelTitleId">詳情</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form>
                        <fieldset class="form-group">
                            <div class="row">
                                <legend class="col-form-label col-sm-2 pt-0">時間：</legend>
                                <div class="col-sm-10">
                                    <div class="form-check form-check-inline">
                                        <input id="rResult" type="email" class="form-control" placeholder="1" readonly>
                                    </div>
                                </div>
                            </div>
                        </fieldset>
                        <div class="form-group row">
                            <label for="inputEmail3" class="col-sm-2 col-form-label"></label>
                            <div class="col-sm-10">
                                <div class="input-group mb-3">
                                    <input id="hourResult" type="document" class="form-control" placeholder="2" readonly>
                                    <div class="input-group-append">
                                        <span class="input-group-text" id="basic-addon2">點</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group row">
                            <label for="inputPassword3" class="col-sm-2 col-form-label"></label>
                            <div class="col-sm-10">
                                <div class="input-group mb-3">
                                    <input id="minuteResult" type="email" class="form-control" placeholder="3" readonly>
                                    <div class="input-group-append">
                                        <span class="input-group-text" id="basic-addon2">分</span>
                                    </div>
                                </div>

                            </div>
                        </div>

                        <div class="form-group row">
                            <div class="col-sm-2">待辦事項：</div>
                            <div class="col-sm-10">
                                <input id="affairsResult" type="email" class="form-control" placeholder="4" readonly>
                            </div>
                        </div>
                        <div class="form-group row">
                            <div class="col-sm-2">地點：</div>
                            <div class="col-sm-10">
                                <div class="input-group">
                                    <input id="iptGoogleMapResult" type="text" class="form-control" placeholder="5" aria-label="Recipient's username" aria-describedby="basic-addon2"
                                        readonly>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">關閉</button>
                    <button id="save" type="button" class="btn btn-primary" data-dismiss="modal">確定</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC68uTPo1yV0Z5lUsWFIE_4RkOgfXLI6sQ" async defer></script>
    <script>
        var now = new Date();
        var nowYear = now.getFullYear();
        var nowMonth = now.getMonth();
        var nowDate = now.getDate();


        var MonthArray = ["January", "February", "March", "April", "May", "June", "July", "August", "September",
            "October", "Novenber", "December"
        ];
        var calendar_year = document.getElementById("calendar-year");
        var calendar_month = document.getElementById("calendar-month");

        function refresh() {
            var count = 0;
            var lastMonth = last(nowYear, nowMonth);
            var nowEnd = End(nowYear, nowMonth);
            var nextMonth = next(nowYear, nowMonth);
            calendar_month.innerText = MonthArray[nowMonth];
            calendar_year.innerText = nowYear;

            var tbody = document.getElementById("tbody");
            var tr = document.createElement("tr");
            if (lastMonth.getDay() != 6) {
                for (var i = lastMonth.getDay(); i >= 0; i--) {
                    count++;
                    tr.innerHTML += '<td class = "text-gray">' + (lastMonth.getDate() - i) + '</td>';
                    tbody.appendChild(tr);
                }
            }

            for (var i = 1; i <= nowEnd.getDate(); i++) {
                count++;
                if (count % 7 == 1) {
                    tr = document.createElement("tr");
                }
                if (i == now.getDate() &&
                    nowEnd.getMonth() == now.getMonth() &&
                    nowEnd.getFullYear() == now.getFullYear()) {
                    tr.innerHTML += '<td class = "nowdate" data-toggle="modal" data-target="#modalResult">' + i +
                        '</td>';
                } else {
                    tr.innerHTML += '<td data-toggle="modal" data-target="#modelId">' + i + '</td>';
                }
                tbody.appendChild(tr);
            }

            var getnextMonth = nextMonth.getDate();
            for (var i = nextMonth.getDay(); i < 7; i++) {
                count++;
                if (count % 7 == 1) {
                    tr = document.createElement("tr");
                }
                tr.innerHTML += '<td class = "text-gray">' + (getnextMonth++) + '</td>';
                tbody.appendChild(tr);
            }
            clicktd();
            get_localStorage();
        }
        refresh();

        function End(nowYear, nowMonth) {
            return new Date(nowYear, nowMonth + 1, 0)
        }

        function last(nowYear, nowMonth) {
            return new Date(nowYear, nowMonth, 0);
        }

        function next(nowYear, nowMonth) {
            return new Date(nowYear, nowMonth + 1, 1);
        }

        gotoprev.onclick = function (e) {
            e.preventDefault();
            var gettrs = document.querySelectorAll('tbody tr');
            for (var gettr of gettrs) {
                gettr.parentNode.removeChild(gettr);
            }
            nowMonth--;
            if (nowMonth < 0) {
                nowYear--;
                nowMonth = 11;
            }
            refresh();
            // clicktd();
            // get_localStorage();
            tbutton();
        }

        gotonext.onclick = function (e) {
            e.preventDefault();
            var gettrs = document.querySelectorAll('tbody tr');
            for (var gettr of gettrs) {
                gettr.parentNode.removeChild(gettr);
            }
            nowMonth++;
            if (nowMonth > 11) {
                nowYear++;
                nowMonth = 0;
            }
            refresh();
            // clicktd();
            // get_localStorage();
            tbutton();
        }

        //------------------localstorage------------------
        //td onclick

        var tdSchedule = ["date", "year", "month"];

        function clicktd() {
            var tds = document.getElementsByTagName("td");
            for (var i = 0; i < tds.length; i++) {
                var td = tds[i];
                td.onclick = function () {
                    var t = event.srcElement;
                    tdSchedule["date"] = t.innerText;
                    tdSchedule["month"] = calendar_month.innerText;
                    tdSchedule["year"] = calendar_year.innerText;
                }
            }
        }

        //save modal   
        var button = document.getElementById("save");

        var morning = document.getElementById("morning");
        var afternoon = document.getElementById("afternoon");
        var radio;
        var Schedule, getSchedule;
        button.onclick = function () {
            if (morning.checked == true) {
                radio = "上午";
            } else if (afternoon.checked == true) {
                radio = "下午";
            }

            getSchedule = new_Schedule();
            var stringSchedule = JSON.stringify(getSchedule);
            localStorage[getSchedule.key] = stringSchedule;
            get_localStorage();
            tbutton();
        }

        //set schedule
        function get_localStorage() {
            var tds = document.getElementsByTagName("td");
            for (var i = 0; i < tds.length; i++) {
                var td = tds[i];
                for (var j = 0; j < localStorage.length; j++) {
                    var objectSchedule = JSON.parse(localStorage[localStorage.key(j)]);

                    if (objectSchedule.year == calendar_year.innerText &&
                        objectSchedule.month == calendar_month.innerText &&
                        objectSchedule.date == td.innerText) {
                        td.innerHTML +=
                            '<button role="Result" data-toggle="modal" data-target="#modalResult" name="tdbutton" id="' +
                            localStorage.key(j) + '">' + '查看詳情';

                        var btnDelete = document.createElement("button");
                        btnDelete.textContent = "刪除";
                        td.appendChild(btnDelete);
                    }
                }
            }
        }

        function tbutton() {
            var tdbuttons = document.getElementsByName("tdbutton");
            console.log(tdbuttons.length);
            for (var i = 0; i < tdbuttons.length; i++) {
                var tdbutton = tdbuttons[i];
                tdbutton.onclick = function () {
                    var td = event.srcElement;
                    for (var j = 0; j < localStorage.length; j++) {
                        var objectSchedule = JSON.parse(localStorage[localStorage.key(j)]);
                        if (td.id == localStorage.key(j)) {
                            document.getElementById("rResult").value = objectSchedule.r;
                            document.getElementById("hourResult").value = objectSchedule.hour;
                            document.getElementById("minuteResult").value = objectSchedule.minute;
                            document.getElementById("affairsResult").value = objectSchedule.affairs;
                            document.getElementById("iptGoogleMapResult").value = objectSchedule.googlemap;
                        }
                    }
                }
            }
        }
        //--------------------Map--------------------
        var btnMap = document.getElementById("btnGoogleMap");
        var result_inputMap = null;
        btnMap.onclick = function () {
            var map;
            var marker = null;
            map = new google.maps.Map(
                document.getElementById('map'), {
                    center: {
                        lat: 24.7571075,
                        lng: 120.952429
                    },
                    zoom: 15
                });
            map.addListener('click', function (e) {
                var geo = new google.maps.Geocoder();

                geo.geocode({
                    'latLng': e.latLng
                }, function (results, status) {
                    if (status === google.maps.GeocoderStatus.OK) {
                        // 如果有資料就會回傳
                        if (results) {
                            result_inputMap = results[0].formatted_address;

                            if (marker != null) {
                                marker.setMap(null);
                                marker = null;
                            }
                            marker = new google.maps.Marker({
                                position: e.latLng,
                                map: map,
                                title: e.latLng.toString()
                            });
                        }
                    }
                    // 經緯度資訊錯誤
                    else {
                        alert("Reverse Geocoding failed because: " + status);
                    }
                });
            });
        }

        //saveMap
        var saveMap = document.getElementById("saveMap");
        saveMap.onclick = function () {
            console.log(result_inputMap);
            if (result_inputMap != null) {
                document.getElementById("iptGoogleMap").value = result_inputMap;
            } else {
                document.getElementById("iptGoogleMap").value = "null";
            }
        }


        // var DeletelocalStorage = document.getElementsByTagName("button");
        // for (var i = 0; i < DeletelocalStorage.length; i++) {
        //     deletelocal = DeletelocalStorage[i];
        //     deletelocal.onclick = function () {
        //         var d = event.srcElement;
        //         localStorage.removeItem(d.id);
        //         get_localStorage();
        //     }
        // }

        var hour = document.getElementById("hour");
        var minute = document.getElementById("minute");
        var affairs = document.getElementById("affairs");
        var color = document.getElementById("color");

        function new_Schedule() {
            Schedule = {
                key: '',
                year: tdSchedule["year"],
                month: tdSchedule["month"],
                date: tdSchedule["date"],
                hour: hour.value,
                minute: minute.value,
                r: radio,
                affairs: affairs.value,
                color: color.value,
                googlemap: result_inputMap
            }
            Schedule.key = _uuid();
            return Schedule;
        }

        //new uuid
        function _uuid() {
            var d = Date.now();
            if (typeof performance !== 'undefined' && typeof performance.now === 'function') {
                d += performance.now(); //use high-precision timer if available
            }
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                var r = (d + Math.random() * 16) % 16 | 0;
                d = Math.floor(d / 16);
                return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
            });
        }
    </script>

    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
        crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
        crossorigin="anonymous"></script>

</body>

</html>